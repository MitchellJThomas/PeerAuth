<!DOCTYPE html>
<html>
<head>
    <title>PeerAuth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
    <h1>PeerAuth</h1>
    <h2>What is this?</h2>
    <p>Machine learning has become more and more powerful, to the point where a bad actor can take a photo and a voice
      recording of someone you know, and forge a complete video recording. See the "OmniHuman-1" model developed by ByteDance:<br>
      <ul>
      <li><a href="https://x.com/ai_for_success/status/1886685232952435133">discussion on X</a></li>
      <li><a href="https://omnihuman-lab.github.io/">ByteDance's paper</a></li>
      </ul>
    </p>
    <p>Bad actors can now digitally impersonate someone you love, and trick you into doing things like paying a ransom.</p>
    <p>To mitigate that risk, I have developed this simple solution where you can setup a unique time-based one-time passcode (TOTP) between any pair of persons.</p>
    <p>This is how it works:</p>
    <ol>
    <li>Two people, Alice and Bob, sit in front of the same computer and open this page;</li>
    <li>Alice and Bob input their respective names onto the same page, and click "Generate";</li>
    <li>The page will generate two TOTP QR codes, one for Alice and one for Bob;</li>
    <li>Alice and Bob scan the respective QR code into a TOTP mobile app (such as Authy or Google Authenticator) on their respective phones;</li>
    <li>In the future, when Alice speaks with Bob over the phone or over video call, and wants to verify the identity of Bob, Alice asks Bob to provide the 6-digit TOTP code from the mobile app. If the code matches what Alice has on her own phone, then Alice has more confidence that she is speaking with the real Bob.</li>
    </ol>
    <p>Note that this depends on both Alice's and Bob's phones being secure. If somebody steals Bob's phone and manages to bypass the fingerprint or PIN or facial recognition of Bob's phone, then all bets are off.</p>
    <div class="mb-3">
        <label for="name1" class="form-label">Person 1</label>
        <input type="text" class="form-control" id="name1" required>
    </div>
    
    <div class="mb-3">
        <label for="name2" class="form-label">Person 2</label>
        <input type="text" class="form-control" id="name2" required>
    </div>
    
    <button id="generateBtn" class="btn btn-primary mb-4" disabled>Generate</button>
    
    <div id="qrSection" style="display: none;">
        <div class="row">
            <div class="col-md-6 mb-4">
                <p id="label1"></p>
                <div id="qrcode1"></div>
            </div>
            <div class="col-md-6 mb-4">
                <p id="label2"></p>
                <div id="qrcode2"></div>
            </div>
        </div>
        
        <div class="mt-4">
            <h4>Verification OTP:</h4>
            <p id="otpDisplay1" class="h2"></p>
            <p>Expires in <span id="countdown">30</span> seconds</p>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.3.6/otpauth.umd.min.js"></script>

    <script>
        const inputs = document.querySelectorAll('input');
        const generateBtn = document.getElementById('generateBtn');
        let totp1 = null;
        let totp2 = null;
        let interval = null;

        // Enable generate button only when both fields are filled
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                generateBtn.disabled = !(
                  document.getElementById('name1').value && 
                  document.getElementById('name2').value
                );
            });
        });

        generateBtn.addEventListener('click', () => {
            if (interval !== null) { clearInterval(interval); }

            const name1 = document.getElementById('name1').value;
            const name2 = document.getElementById('name2').value;
            
            // Generate cryptographically secure secret
            const secret = new OTPAuth.Secret({ size: 20 });
            const algorithm = 'SHA1';
            const issuer = 'PeerAuth';
            const digits = 6;
            const period = 30;

            // Initialize TOTP
            totp1 = new OTPAuth.TOTP({
              issuer,
              label: encodeURIComponent(name1),
              algorithm,
              digits,
              period,
              secret,
            });
            totp2 = new OTPAuth.TOTP({
              issuer,
              label: encodeURIComponent(name2),
              algorithm,
              digits,
              period,
              secret,
            })

            function updateOtpDisplay() {
                if (!totp1) return;
                
                const now = Math.floor(Date.now() / 1000);
                const remaining = 30 - (now % 30);
                
                document.getElementById('otpDisplay1').textContent = totp1.generate();
                document.getElementById('countdown').textContent = remaining;
            }

            // Create OTP URIs
            // Fixed URI format with proper encoding
            const encodeLabel = (name) => 
                    `PeerAuth:${encodeURIComponent(name)}`;
    
            const uri1 = totp1.toString();

            const uri2 = totp2.toString();

                        // Display QR codes
            document.getElementById('label1').textContent = `${name2}, please scan this:`;
            document.getElementById('label2').textContent = `${name1}, please scan this:`;
            
            document.getElementById('qrSection').style.display = 'block';
            
            // Generate QR code elements
            new QRCode(document.getElementById('qrcode1'), {
                text: uri1,
                width: 200,
                height: 200,
                correctLevel: QRCode.CorrectLevel.H
            });
            
            new QRCode(document.getElementById('qrcode2'), {
                text: uri2,
                width: 200,
                height: 200,
                correctLevel: QRCode.CorrectLevel.H
            });

            updateOtpDisplay();
            interval = setInterval(updateOtpDisplay, 1000);
        });
    </script>
</body>
</html>
